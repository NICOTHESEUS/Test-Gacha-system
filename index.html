<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Game</title>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.1.3/firebase-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.1.3/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.1.5"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@3.3.0"></script>
</head>
<body>
  <div id="app"></div>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();

    let userId = "testUserId"; // Replace with actual user ID
    let inventory = []; // Holds all user units (units to battle)
    let userProgress = {}; // Stores user progress data (e.g., orbs, scrap)
    let isLoading = true;

    // Firestore load data function
    useEffect(() => {
      loadData();
    }, []);

    const loadData = async () => {
      try {
        // Fetch user progress and units from Firebase Firestore
        const progressSnapshot = await firestore.collection('userProgress').doc(userId).get();
        const userUnitsSnapshot = await firestore.collection('units').where('userId', '==', userId).get();

        if (progressSnapshot.exists) {
          setUserProgress(progressSnapshot.data());
        } else {
          const newProgress = await UserProgress.create({});
          setUserProgress(newProgress);
        }

        const userUnits = userUnitsSnapshot.docs.map(doc => doc.data());
        setUnits(userUnits);
      } catch (error) {
        console.error('Error loading data:', error);
      }
      setIsLoading(false);
    };

    // UI loading spinner
    if (isLoading) {
      return (
        <div className="flex items-center justify-center min-h-screen">
          <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-purple-500"></div>
        </div>
      );
    }

    // Mission System & Battle Logic
    function startMission(name) {
      const mission = { name: name, difficulty: 1, baseHP: 100, enemies: 3, boss: false, reward: { scrap: 50, bossScrap: 0 } };
      const battleDiv = document.getElementById("battlePreview");
      battleDiv.innerHTML += `<div id="combatAnimation" style="position:relative;width:100%;height:150px;"></div>`;
      const animDiv = document.getElementById("combatAnimation");

      let totalEnemies = mission.enemies;
      let missionHP = mission.baseHP;

      function simulateTurn(i) {
        if (i >= totalEnemies) {
          scrap += mission.reward.scrap;
          bossScrapA += mission.reward.bossScrap;
          if (mission.boss) legendaryBossesDefeated++;
          showNotification(`âœ… Mission Completed! Loot: ${mission.reward.scrap} Scrap${mission.reward.bossScrap > 0 ? ', ' + mission.reward.bossScrap + ' Boss Scrap' : ''}`);
          checkAchievements(); checkUnlocks(); saveAll(); updateUI();
          return;
        }

        let unit = inventory[Math.floor(Math.random() * inventory.length)];
        if (!unit) return;

        let damage = Math.floor(Math.random() * 10 + 5);
        missionHP -= damage;
        showDamageNumber(animDiv, damage);
        battleDiv.innerHTML += `<div style="font-size:14px;">${unit.name} dealt ${damage} damage!</div>`;

        let enemyDamage = Math.floor(Math.random() * 5 + 3);
        unit.hp = Math.max(0, unit.hp - enemyDamage);
        showDamageNumber(animDiv, enemyDamage, false);
        battleDiv.innerHTML += `<div style="font-size:14px;color:red;">Enemy dealt ${enemyDamage} damage to ${unit.name}</div>`;

        setTimeout(() => simulateTurn(i + 1), 500);
      }

      simulateTurn(0);
    }

    function showDamageNumber(parent, damage, crit = false) {
      const el = document.createElement("div");
      el.style.position = "absolute";
      el.style.color = crit ? "red" : "yellow";
      el.style.fontWeight = "bold";
      el.style.fontSize = "16px";
      el.style.top = "50%"; el.style.left = "50%";
      el.innerText = "-" + damage;
      parent.appendChild(el);

      let y = 0;
      let opacity = 1;
      const anim = setInterval(() => {
        y++; opacity -= 0.03;
        el.style.top = (50 - y) + "%";
        el.style.opacity = opacity;
        if (opacity <= 0) { clearInterval(anim); el.remove(); }
      }, 30);
    }

    // Unit Inventory Management
    let equipmentInventory = []; // holds weapons & armor

    function installEquipment(unit, equip) {
      let weaponSlots = 1;
      if (unit.rarity >= 7 && unit.rarity < 10) weaponSlots = 2;
      if (unit.rarity === 10) weaponSlots = 3;

      let armorSlots = 4;
      if (unit.weapons && unit.weapons.length >= weaponSlots) return showNotification("All weapon slots full!");

      if (!unit.weapons) unit.weapons = [];
      unit.weapons.push(equip); // Add new equipment (weapon) to unit
      saveUnitToFirestore(unit); // Save the updated unit in Firestore
    }

    // Add new Unit
    const addNewUnit = async () => {
      const newUnit = {
        name: "New Warrior",
        type: "Warrior",
        level: 1,
        hp: 100,
        rarity: 5,
        weapons: [] // No weapons initially
      };

      await firestore.collection('units').add({
        ...newUnit,
        userId: userId // Link this unit to user
      });

      loadData(); // Reload data
    };

    // Unit Display in UI
    const renderUnitListPanel = () => {
      const panel = document.getElementById("unitListPanel");
      panel.innerHTML = "";
      inventory.forEach(u => {
        const div = document.createElement("div");
        div.className = "inv-item r" + u.rarity;
        div.innerText = `${u.name} Lv.${u.level} HP:${u.hp}`;
        panel.appendChild(div);
      });
    };

    // Update UI
    const updateUI = () => {
      document.getElementById("orbsDisplay").innerText = orbs;
      document.getElementById("scrapDisplay").innerText = scrap;
      document.getElementById("bossScrapDisplay").innerText = bossScrapA;
      document.getElementById("overdriveDisplay").innerText = activeOverdrives.length > 0 ? activeOverdrives.map(o => o.name).join(",") : "None";
      renderUnitListPanel(); renderMap(); renderAchievements();
    };

    // Render map for planets (Galaxy Progression)
    const renderMap = () => {
      const mapPanel = document.getElementById("mapPanel");
      mapPanel.innerHTML = "";
      galaxyProgression.forEach(loc => {
        const marker = document.createElement("div");
        marker.style.position = "absolute"; marker.style.width = "50px"; marker.style.height = "50px";
        marker.style.borderRadius = "50%"; marker.style.left = loc.x + "px"; marker.style.top = loc.y + "px";
        marker.style.background = loc.unlocked ? "#0af" : "#444";
        marker.title = loc.name + (loc.unlocked ? "" : " (Locked)");
        if (loc.unlocked) marker.onclick = () => previewBattle({ name: loc.name, difficulty: 1, baseHP: 100, enemies: 3, boss: false, reward: { scrap: 50, bossScrap: 0 } });
        mapPanel.appendChild(marker);
      });
    };

    // Initialize app (on load)
    updateUI();
    renderMap();
    renderAchievements();
  </script>
</body>
</html>
