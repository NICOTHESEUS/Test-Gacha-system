<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galactic Drop Pod</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #222;
      color: white;
      margin: 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    .result {
      margin-top: 20px;
      font-size: 20px;
    }
    .inventory, #achievementPanel, #battlePreview, #mapPanel {
      margin-top: 20px;
      padding: 10px;
      border: 2px solid #555;
      border-radius: 12px;
      background: #111;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      max-height: 300px;
      overflow-y: auto;
    }
    .inv-item {
      padding: 4px;
      border-bottom: 1px solid #444;
      cursor: pointer;
    }
    .r3, .r4, .r5 { color: lightblue; font-weight: bold; }
    .r6 { color: violet; font-weight: bold; }
    .r7 { color: orange; font-weight: bold; }
    .r8 { color: darkorange; font-weight: bold; }
    .r9 { color: gold; font-weight: bold; }
    .r10 { color: white; background: gold; padding: 2px 6px; border-radius: 4px; font-weight: bold; animation: glow 1.5s infinite; }
    @keyframes glow { 0% { box-shadow: 0 0 5px gold; } 50% { box-shadow: 0 0 20px gold; } 100% { box-shadow: 0 0 5px gold; } }
    @media (max-width: 600px) {
      #mapPanel { height: 200px; }
      .inventory, #achievementPanel, #battlePreview { max-width: 95%; }
    }
  </style>
</head>
<body>

<!-- LOGIN PANEL -->
<div id="loginPanel">
  <h2>Base</h2>
  <button onclick="googleLogin()">Login with Google</button>
</div>

<!-- GAME PANEL -->
<div id="gamePanel" style="display:none;">
  <div id="playerInfo">
    <img id="playerAvatar" src="" alt="Avatar"/>
    <span id="playerName">Player</span>
  </div>

  <div id="resourceBar" style="display:flex;gap:20px;justify-content:center;margin-top:10px;flex-wrap:wrap;">
    <div>üöÄ Orbs: <span id="orbsDisplay">1600</span></div>
    <div>üîß Scrap: <span id="scrapDisplay">0</span></div>
    <div>üíé Boss Scrap: <span id="bossScrapDisplay">0</span></div>
    <div>üí• Overdrive: <span id="overdriveDisplay">None</span></div>
  </div>

  <div style="margin-top:15px;">
    <button onclick="pull(1)">Pull 1 (160 Orbs)</button>
    <button onclick="pull(10)">Pull 10 (1600 Orbs)</button>
    <button onclick="earnOrbs()">Earn 200 Orbs</button>
    <button onclick="resetGame()">Reset Game</button>
  </div>

  <div class="result" id="results"></div>

  <div class="inventory">
    <h3>Units</h3>
    <div id="unitListPanel">Empty</div>
  </div>

  <div id="battlePreview">
    <div id="combatLog"></div>
    <div id="bossHealthContainer">
      <div id="bossHealthBar"></div>
    </div>
  </div>

  <div id="mapPanel">
    <h3>Map</h3>
    <button onclick="startBossBattle()">Start Boss Battle</button>
    <button onclick="startMiniGame()">Start Mini Game</button>
    <div id="mapLocations">Loading map...</div>
  </div>

  <div id="achievementPanel">
    <h3>Achievements</h3>
    <div id="achievementList"></div>
  </div>

  <!-- SYNC CONTROLS -->
  <div id="syncControls">
    <button onclick="syncUpload()">‚¨Ü Upload</button>
    <button onclick="syncDownload()">‚¨á Download</button>
    <button onclick="syncAll()">üîÑ Sync All</button>
    <span id="syncIcon">‚ùå</span> <span id="syncStatus">Offline</span>
    <span id="lastSynced">Never</span>
  </div>
</div>

<div id="gameNotifications"></div>

<!-- Firebase Modular SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js';
  import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-analytics.js';

  // ---------------- FIREBASE ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyDlfDBnFHP78CnP7H_J6fU40-R_2sq3gRU",
    authDomain: "basegame-4c97c.firebaseapp.com",
    projectId: "basegame-4c97c",
    storageBucket: "basegame-4c97c.appspot.com",
    messagingSenderId: "275532742335",
    appId: "1:275532742335:web:dcdabf04452470054dd00a",
    measurementId: "G-ZDNWTVJT2E"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);

  // ---------------- LOGIN ----------------
  function googleLogin() {
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider)
      .then(result => {
        const user = result.user;
        document.getElementById("playerName").innerText = user.displayName;
        document.getElementById("playerAvatar").src = user.photoURL;
        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("gamePanel").style.display = "block";
        loadGameData(user.uid);
        showNotification(`Logged in as ${user.displayName}`);
      })
      .catch(err => alert(err.message));
  }

  onAuthStateChanged(auth, user => {
    if (user) {
      document.getElementById("playerName").innerText = user.displayName;
      document.getElementById("playerAvatar").src = user.photoURL;
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("gamePanel").style.display = "block";
      loadGameData(user.uid);
    } else {
      document.getElementById("loginPanel").style.display = "block";
      document.getElementById("gamePanel").style.display = "none";
    }
  });

  // ---------------- GAME STATE ----------------
  let orbs = 1600, scrap = 0, bossScrapA = 0;
  let pullCount = 0, legendaryBossesDefeated = 0, eliteEventsDefeated = 0;
  let activeOverdrives = [], inventory = [];
  let currentUID = "";

  // Gacha pool and rates
  let pool = [
    { name: "NICO Theseus", rarity: 10 }, { name: "FREDRIK Astartes", rarity: 7 },
    { name: "Osiris", rarity: 9 }, { name: "Architect", rarity: 9 },
    { name: "Placeholder 7", rarity: 6 }, { name: "Placeholder 6", rarity: 5 },
    { name: "Placeholder 5", rarity: 4 }, { name: "Placeholder 4", rarity: 3 },
    { name: "Placeholder 3", rarity: 3 }, { name: "Placeholder 2", rarity: 3 },
    { name: "Placeholder 1", rarity: 3 }
  ];
  const rawRates = { 10: 0.008, 9: 0.02, 8: 0.008, 7: 0.01, 6: 0.08, 5: 0.13, 4: 0.20, 3: 0.70 };
  const totalRate = Object.values(rawRates).reduce((a, b) => a + b, 0);
  const rates = {};
  for (let k in rawRates) { rates[k] = rawRates[k] / totalRate; }

  // ---------------- UTILITY FUNCTIONS ----------------
  function showNotification(msg, duration = 3000) {
    const notif = document.createElement("div");
    notif.innerText = msg;
    notif.style.background = "#333";
    notif.style.padding = "8px";
    notif.style.marginTop = "5px";
    notif.style.borderRadius = "6px";
    notif.style.animation = `notifSlide ${duration / 1000}s ease forwards`;
    document.getElementById("gameNotifications").appendChild(notif);
    setTimeout(() => notif.remove(), duration);
  }

  function chooseRarity() {
    let r = Math.random(), sum = 0;
    const keys = Object.keys(rates).sort((a, b) => b - a);
    for (let k of keys) { sum += rates[k]; if (r <= sum) return parseInt(k); }
    return 3;
  }

  function getCharacter(rarity) {
    const list = pool.filter(c => c.rarity === rarity);
    return list[Math.floor(Math.random() * list.length)];
  }

  // ---------------- INVENTORY ----------------
  function addToInventory(newChar) {
    let found = inventory.find(c => c.name === newChar.name);
    if (found) {
      found.level = Math.min(10, found.level + 1);
    } else {
      inventory.push({ ...newChar, level: 1, hp: 100, attack: 10, defense: 5, weapons: [], armor: [] });
    }
  }

  // ---------------- SAVE / LOAD ----------------
  function saveGameData() {
    if (!currentUID) return;
    setDoc(doc(db, "users", currentUID), {
      orbs, scrap, bossScrapA, pullCount, legendaryBossesDefeated, eliteEventsDefeated, activeOverdrives, inventory,
      lastSynced: serverTimestamp()
    }).then(() => updateSyncStatus("online"))
    .catch(err => { console.error("Save Error:", err); updateSyncStatus("offline"); });
  }

  function loadGameData(uid) {
    currentUID = uid;
    const userDoc = doc(db, "users", uid);
    getDoc(userDoc).then(doc => {
      if (doc.exists()) {
        const cloud = doc.data();
        mergeInventory(cloud.inventory || []);
        orbs = cloud.orbs ?? 1600;
        scrap = cloud.scrap ?? 0;
        bossScrapA = cloud.bossScrapA ?? 0;
        pullCount = cloud.pullCount ?? 0;
        legendaryBossesDefeated = cloud.legendaryBossesDefeated ?? 0;
        eliteEventsDefeated = cloud.eliteEventsDefeated ?? 0;
        activeOverdrives = cloud.activeOverdrives ?? [];
        showNotification("‚òÅ Cloud Save Loaded");
      } else {
        saveGameData();
        showNotification("üíæ No Cloud Save found, local save uploaded");
      }
      updateUI();
    }).catch(err => { console.error(err); updateSyncStatus("offline"); showNotification("‚ùå Failed to load Cloud Save"); });
  }

  // ---------------- SYNC ----------------
  function syncUpload() { saveGameData(); }
  function syncDownload() { if (currentUID) loadGameData(currentUID); }
  function syncAll() { if (currentUID) { loadGameData(currentUID); saveGameData(); showNotification("üîÑ Synced All"); } }

  function updateSyncStatus(status) {
    document.getElementById("syncStatus").innerText = status.charAt(0).toUpperCase() + status.slice(1);
    document.getElementById("syncIcon").innerText = status === "online" ? "‚úÖ" : "‚ùå";
  }

  // ---------------- BOSS BATTLE ----------------
  function startBossBattle() {
    let bossHealth = 100;
    let bossAttack = 15;
    let playerHealth = 100;
    let playerAttack = 20;
    let log = [];

    function combatTurn() {
      if (playerHealth <= 0 || bossHealth <= 0) {
        if (playerHealth <= 0) log.push("You were defeated by the boss!");
        if (bossHealth <= 0) log.push("You defeated the boss!");
        document.getElementById("combatLog").innerText = log.join("\n");
        return;
      }
      
      // Player's turn
      bossHealth -= playerAttack;
      log.push(`You hit the boss for ${playerAttack} damage!`);
      
      // Boss's turn
      playerHealth -= bossAttack;
      log.push(`The boss hits you for ${bossAttack} damage!`);
      
      // Update UI
      document.getElementById("bossHealthBar").style.width = `${(bossHealth / 100) * 100}%`;
      document.getElementById("combatLog").innerText = log.join("\n");

      setTimeout(combatTurn, 1500); // Repeat turn
    }

    combatTurn();
  }

  // ---------------- MINI GAME ----------------
  function startMiniGame() {
    let success = Math.random() > 0.5; // 50% chance to succeed
    if (success) {
      showNotification("You completed the mini-game! +100 Orbs.");
      orbs += 100;
    } else {
      showNotification("You failed the mini-game... Better luck next time.");
    }
    saveGameData();
  }

  // ---------------- INITIALIZE ----------------
  updateUI(); renderMap(); renderAchievements();
</script>

</body>
</html>
